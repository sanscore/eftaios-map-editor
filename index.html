<html>
  <head>
    <script src="https://unpkg.com/honeycomb-grid@3.0.0/dist/honeycomb.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  </head>
  <body>

  <div id="container">
    <div id="drawing"></div>
  </div>
    <style type="text/css">
div {
  display: inline-block;
}
svg text{
   -webkit-user-select: none;
   -moz-user-select: none;
   -ms-user-select: none;
   user-select: none;
}
    </style>
    <script>

var dragging = false
function makeDraggable(evt) {
  var svg = evt.target;
  svg.addEventListener('mousedown', startDrag);
  svg.addEventListener('mousemove', drag);
  svg.addEventListener('mouseup', endDrag);
  svg.addEventListener('mouseleave', endDrag);

  function getMousePosition(evt) {
    var CTM = svg.getScreenCTM();
    return {
      x: (evt.clientX - CTM.e) / CTM.a,
      y: (evt.clientY - CTM.f) / CTM.d
    };
  }

  var selectedElement, offset, origin;

  function startDrag(evt) {
    var draggable;
    if (evt.target.classList.contains('draggable')) {
      draggable = evt.target
    } else if (evt.target.parentNode && evt.target.parentNode.classList.contains('draggable')) {
      draggable = evt.target.parentNode
    }

    if (draggable != null) {
      var child = draw.select(`#${draggable.id}`).first()
      parent = child.parent()

      if (
           (parent == legend_human && human_hex)
        || (parent == legend_alien && alien_hex)
        || (parent == legend_pod1 && pod1_hex)
        || (parent == legend_pod2 && pod2_hex)
        || (parent == legend_pod3 && pod3_hex)
        || (parent == legend_pod4 && pod4_hex)
      ){ return; }
      selectedElement = parent

      parent.front();
      origin = {x: selectedElement.x(), y: selectedElement.y()}
      offset = getMousePosition(evt);
      dragging = true
    }
  }

  function drag(evt) {
    if (selectedElement) {
      evt.preventDefault();
      var coord = getMousePosition(evt);
      selectedElement.dmove(coord.x - offset.x, coord.y - offset.y);
      selectedElement.front();
      offset = coord;
    }
  }

  function endDrag(evt) {
    if (selectedElement) {
      selectedElement.move(origin.x, origin.y);

      let dx = evt.pageX - drawing.offsetLeft
      let dy = evt.pageY - drawing.offsetTop
      const hexCoordinates = Grid.pointToHex([dx - grid_offset_x, dy - grid_offset_y])
      const hex = grid.get(hexCoordinates)

      if (hex != null) {
        nullifyHex(hex);
        switch(selectedElement){
          case legend_human:
            hex.human()
            break;
          case legend_alien:
            hex.alien()
            break;
          case legend_pod1:
            hex.pod1()
            break;
          case legend_pod2:
            hex.pod2()
            break;
          case legend_pod3:
            hex.pod3()
            break;
          case legend_pod4:
            hex.pod4()
            break;
        }
      }
    }
    selectedElement = null;
    dragging = false
  }
}

const xpos = [
  "A", "B", "C", "D", "E", "F",
  "G", "H", "I", "J", "K", "L",
  "M", "N", "O", "P", "Q", "R",
  "S", "T", "U", "V", "W",
]

const ypos = [
  "01", "02", "03", "04", "05", "06",
  "07", "08", "09", "10", "11", "12",
  "13", "14",
]


const grid_offset_x = 0
const grid_offset_y = 20

const hex_size = 25
const grid_hex_width = 23
const grid_hex_height = 14

const sqrt3 = Math.sqrt(3)
const padding = 2
const grid_px_width = (hex_size/2) * (grid_hex_width*3+1) + padding
const grid_px_height = hex_size * sqrt3 * (grid_hex_height + 0.5) + padding

const footer_top = grid_offset_y + grid_px_height + 2*padding
const footer_height = 100

const drawing_width = grid_offset_x + grid_px_width
const drawing_height = grid_offset_y + grid_px_height + footer_height

const drawing = document.getElementById('drawing')
const draw = SVG(drawing).size(drawing_width, drawing_height)

draw.on('load', (evt) => { makeDraggable(evt);})

cols = draw.group().id('cols')
for(let i = 0, j = 32; i < xpos.length; ++i, j+=37.5) { 
  // TODO: move text/font details to a style
  cols
    .text(xpos[i])
    .font({
      family: 'Share Tech Mono'
      , size: 16
      , anchor: 'middle'
      , fill: '#838383'
    })
    .center(j, 8)
}

const diagnol_pattern = draw.pattern(24, 24, function(add) {
  add.line(11, -1, 36, 24).stroke({ color: '#838383', width: 1 })
  add.line(-1, 11, 24, 36).stroke({ color: '#838383', width: 1 })
})

draw.rect(grid_px_width, grid_px_height)
  .fill(diagnol_pattern)
  .move(grid_offset_x, grid_offset_y)
  .id('grid')

const htype = {
  NONE: 'none',
  SILENT: 'silent',
  DANGER: 'danger',
  HUMAN: 'human',
  ALIEN: 'alien',
  POD1: 'pod1',
  POD2: 'pod2',
  POD3: 'pod3',
  POD4: 'pod4',
}

human_hex = null
alien_hex = null
pod1_hex = null
pod2_hex = null
pod3_hex = null
pod4_hex = null

const Hex = Honeycomb.extendHex({
  size: hex_size,
  orientation: 'flat',

  toJSON() { return [this.x, this.y, this.type] },

  render(draw) {
    this.draw = draw
    this.blank()
  },

  setPolygon(symbol, text) {
    const {x, y} = this.toPoint().add(grid_offset_x, grid_offset_y)

    if (this.polygon != null) {
      this.polygon.remove()
    }

    if (symbol != null) {
      this.polygon = symbol.clone()
        .translate(x, y)
        .show()
        .on('mouseenter', () => { 
          if(!dragging) {
            this.polygon.front().animate(500).scale(1.2)
          }
        })
        .on('mouseleave', () => { 
          this.polygon.stop(true, true).animate(250).scale(1)
        })

      if (text) {
        t = this.polygon.select('text')

        if (t != null && t.length() > 0) {
          t.first().text(text)
        }
      }
    }
    return this.polygon
  },

  blank() {
    this.type = htype.NONE

    this.setPolygon()
  },

  silent() {
    this.type = htype.SILENT

    this.setPolygon(silent_sym, `${xpos[this.x]}${ypos[this.y]}`)
  },

  danger() {
    this.type = htype.DANGER

    this.setPolygon(danger_sym, `${xpos[this.x]}${ypos[this.y]}`)
  },

  human() {
    human_hex = this
    this.type = htype.HUMAN
    this.setPolygon(human_sym)
  },

  alien() {
    alien_hex = this
    this.type = htype.ALIEN
    this.setPolygon(alien_sym)
  },

  pod1() {
    pod1_hex = this
    this.type = htype.POD1
    this.setPolygon(pod_sym, `1`)
  },

  pod2() {
    pod2_hex = this
    this.type = htype.POD2
    this.setPolygon(pod_sym, `2`)
  },

  pod3() {
    pod3_hex = this
    this.type = htype.POD3
    this.setPolygon(pod_sym, `3`)
  },

  pod4() {
    pod4_hex = this
    this.type = htype.POD4
    this.setPolygon(pod_sym, `4`)
  },

})


const Grid = Honeycomb.defineGrid(Hex)

const xh = Grid.Hex()
const xh_pos = xh.toPoint()
const xh_center = xh.center().add(xh_pos)

silent_sym = draw.group().id('silent')
silent_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#fff'})
  .stroke({ width: 2, color: '#838383' })
  .addClass('highlight')
tx = silent_sym.text('A01')
  .font({
    family: 'Share Tech Mono'
    , size: 16
    , anchor: 'middle'
    , leading: 1.4
    , fill: '#000'
  })
  .center(40,23)
silent_sym.hide()

danger_sym = draw.group().id('danger')
danger_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill('#838383')
  .stroke({width: 2, color: '#838383'})
danger_sym.polygon([
  [4,0],      [6,0],      [7,sqrt3],    [9,sqrt3],   [10,sqrt3*2],
  [9,sqrt3*3],  [10,sqrt3*4], [9,sqrt3*5],  [7,sqrt3*5], [6,sqrt3*6],
  [4, sqrt3*6], [3,sqrt3*5],  [1, sqrt3*5], [0,sqrt3*4], [1,sqrt3*3],
  [0,sqrt3*2],  [1,sqrt3],    [3,sqrt3]
])
  .translate(1,1)
  .fill('#ddd')
  .size(38)
  .center(xh_center.x,xh_center.y)
  .addClass('highlight')
danger_sym.text('A01')
  .font({
    family: 'Share Tech Mono'
    , size: 16
    , anchor: 'middle'
    , leading: 1.4
    , fill: '#000'
  })
  .center(40,23)
danger_sym.hide()

human_sym = draw.group().id('human')
human_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#000'})
  .stroke({ width: 2, color: '#838383' })
  .addClass('highlight')
  .addClass("draggable")
human_sym.path("M18 7 L13 10 V30 L25 38 L37 30 V10 L32 7")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
  .addClass("draggable")
human_sym.path("M13 18 L25 25 L37 18")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
  .addClass("draggable")
human_sym.hide()

alien_sym = draw.group().id('alien')
alien_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#000'})
  .stroke({ width: 2, color: '#838383' })
  .addClass('highlight')
  .addClass("draggable")
alien_sym.path("M13 7 L37 20 V34 L25 27 L13 34 V20 L37 7")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
  .addClass("draggable")
alien_sym.hide()

pod_sym = draw.group('pod')
pod_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#000'})
  .stroke({ width: 2, color: '#838383' })
  .addClass('highlight')
  .addClass("draggable")
pod_sym.path("M32 5 H16 L8.5 18")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
  .addClass("draggable")
pod_sym.path("M18 38 H34 L41.5 25")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
  .addClass("draggable")
pod_sym.text('1')
  .addClass("draggable")
  .font({
    family: 'Share Tech Mono'
    , size: 24
    , anchor: 'middle'
    , leading: 1.4
    , fill: '#fff'
    , weight: 'bold'
  })
  .center(32,23)
pod_sym.hide()

controls = draw.group()
controls.text('Silent')
  .move(0,0)
  .on('click', () => { 
    silentGrid()
  })
controls.text('Danger')
  .move(0,20)
  .on('click', () => { 
    dangerGrid()
  })
controls.text('Clear')
  .move(0,40)
  .on('click', () => { 
    blankGrid()
  })
controls.move(0, footer_top)

legend = draw.group()
  .id('legend')
legend.rect(335,80)
  .fill('yellow')
  .stroke({width:2, color: 'blue'})
  .translate(1,1)
legend_human = human_sym.clone()
  .center(30,40)
  .id('legend_human')
  .show()
legend_alien = alien_sym.clone()
  .center(85,40)
  .id('legend_alien')
  .show()
legend_pod1 = pod_sym.clone()
  .center(140,40)
  .id('legend_pod1')
  .show()
legend_pod2 = pod_sym.clone()
  .center(195,40)
  .id('legend_pod2')
  .show()
legend_pod2.select('text').first().text('2')
legend_pod3 = pod_sym.clone()
  .center(250,40)
  .id('legend_pod3')
  .show()
legend_pod3.select('text').first().text('3')
legend_pod4 = pod_sym.clone()
  .center(305,40)
  .id('legend_pod4')
  .show()
legend_pod4.select('text').first().text('4')
legend
  .add(legend_human)
  .add(legend_alien)
  .add(legend_pod1)
  .add(legend_pod2)
  .add(legend_pod3)
  .add(legend_pod4)
legend.move(grid_px_width - 340, footer_top)

const grid = Grid.rectangle({
  width: grid_hex_width,
  height: grid_hex_height,

  onCreate(hex) {
    hex.render(draw)
  }
})

function blankGrid() {
  for(let i = 0; i < grid.length; ++i) {
    let hex = grid.get(i)
    hex.blank()
  }
  human_hex = null
  alien_hex = null
  pod1_hex = null
  pod2_hex = null
  pod3_hex = null
  pod4_hex = null
}

function silentGrid() {
  for(let i = 0; i < grid.length; ++i) {
    let hex = grid.get(i)
    hex.silent()
  }
  human_hex = null
  alien_hex = null
  pod1_hex = null
  pod2_hex = null
  pod3_hex = null
  pod4_hex = null
}

function dangerGrid() {
  for(let i = 0; i < grid.length; ++i) {
    let hex = grid.get(i)
    hex.danger()
  }
  human_hex = null
  alien_hex = null
  pod1_hex = null
  pod2_hex = null
  pod3_hex = null
  pod4_hex = null
}

function loadGrid(str) {
  let grid_array = JSON.parse(str)

  for(let i = 0; i < grid_array.length; ++i) {
    let [ x, y, type ] = grid_array[i]
    let hex = grid.get([x, y])
    let point = hex.toPoint()
    switch(type){
      case htype.NONE:
        hex.blank()
        break;
      case htype.SILENT:
        hex.silent()
        break;
      case htype.DANGER:
        hex.danger()
        break;
      case htype.HUMAN:
        hex.human()
        break;
      case htype.ALIEN:
        hex.alien()
        break;
      case htype.POD1:
        hex.pod1()
        break;
      case htype.POD2:
        hex.pod2()
        break;
      case htype.POD3:
        hex.pod3()
        break;
      case htype.POD4:
        hex.pod4()
        break;
    }
  }
}

function nullifyHex(hex) {
  if (hex != null) {
    switch(hex) {
      case human_hex:
        human_hex = null 
        break;
      case alien_hex:
        alien_hex = null 
        break;
      case pod1_hex:
        pod1_hex  = null 
        break;
      case pod2_hex:
        pod2_hex  = null 
        break;
      case pod3_hex:
        pod3_hex  = null 
        break;
      case pod4_hex:
        pod4_hex  = null 
        break;
    }
  }
}

drawing.addEventListener('mousedown', (evt) => {
  let dx = evt.pageX - drawing.offsetLeft
  let dy = evt.pageY - drawing.offsetTop
  const hexCoordinates = Grid.pointToHex([dx - grid_offset_x, dy - grid_offset_y])
  const hex = grid.get(hexCoordinates)

  if (hex) {
    nullifyHex(hex);

    switch(hex.type){
      case htype.NONE:
        hex.silent()
        break;
      case htype.SILENT:
        hex.danger()
        break;
      case htype.DANGER:
        hex.blank()
        break;
      case htype.HUMAN:
        hex.blank()
        break;
      case htype.ALIEN:
        hex.blank()
        break;
      case htype.POD1:
        hex.blank()
        break;
      case htype.POD2:
        hex.blank()
        break;
      case htype.POD3:
        hex.blank()
        break;
      case htype.POD4:
        hex.blank()
        break;
    }
  }
}, true)

    </script>
  </body>
</html>
