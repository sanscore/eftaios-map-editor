<html>
  <head>
    <script src="https://unpkg.com/honeycomb-grid@3.0.0/dist/honeycomb.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  </head>
  <body>

  <div id="container">
    <div id="cols">
    </div>
    <div id="drawing"></div>
  </div>
    <style type="text/css">
#cols div {
  display: inline;
}
svg text{
   -webkit-user-select: none;
   -moz-user-select: none;
   -ms-user-select: none;
   user-select: none;
}
    </style>
    <script>

const xpos = [
  "A", "B", "C", "D", "E", "F",
  "G", "H", "I", "J", "K", "L",
  "M", "N", "O", "P", "Q", "R",
  "S", "T", "U", "V", "W",
]

const ypos = [
  "01", "02", "03", "04", "05", "06",
  "07", "08", "09", "10", "11", "12",
  "13", "14",
]

const draw_cols = SVG('cols').size(25 * 35 + 2, 20)

for(let i = 0, j = 32; i < xpos.length; ++i, j+=37.5) { 
  draw_cols
    .text(xpos[i])
    .font({
        family: 'Share Tech Mono'
      , size: 16
      , anchor: 'middle'
      , fill: '#000'
    })
    .center(j, 8)
}

const grid_width = 23
const grid_height = 14
const hex_size = 25

const sq3 = Math.sqrt(3)
const drawing = document.getElementById('drawing')
const draw = SVG(drawing).size(hex_size * 35 + 2, hex_size * 14.5 * sq3 + 2)

const diagnol_pattern = draw.pattern(24, 24, function(add) {
  add.line(11, -1, 36, 24).stroke({ color: '#838383', width: 1 })
  add.line(-1, 11, 24, 36).stroke({ color: '#838383', width: 1 })
})

draw.rect(draw.width(), draw.height()).fill(diagnol_pattern)

const htype = {
  NONE: 'none',
  SILENT: 'silent',
  DANGER: 'danger',
  HUMAN: 'human',
  ALIEN: 'alien',
  POD1: 'pod1',
  POD2: 'pod2',
  POD3: 'pod3',
  POD4: 'pod4',
}

human_hex = null
alien_hex = null
pod1_hex = null
pod2_hex = null
pod3_hex = null
pod4_hex = null

const Hex = Honeycomb.extendHex({
  size: hex_size,
  orientation: 'flat',

  toJSON() { return [this.x, this.y, this.type] },

  render(draw) {
    this.draw = draw
    this.blank()
  },

  setPolygon(symbol, text) {
    const {x, y} = this.toPoint()

    if (this.polygon != null) {
      this.polygon.remove()
    }

    if (symbol != null) {
      this.polygon = symbol.clone()
        .on('click', () => { console.log(this) })
        .translate(x, y)
        .show()

      if (text) {
        t = this.polygon.select('text')

        if (t != null && t.length() > 0) {
          t0 = t.get(0).text(text)
        }
      }

      this.polygon.front().stop(true, true).animate(0).scale(1.4).reverse()
    }
    return this.polygon
  },

  blank() {
    this.type = htype.NONE

    this.setPolygon(blank_sym)
  },

  silent() {
    this.type = htype.SILENT

    this.setPolygon(silent_sym, `${xpos[this.x]}${ypos[this.y]}`)
  },

  danger() {
    this.type = htype.DANGER

    this.setPolygon(danger_sym, `${xpos[this.x]}${ypos[this.y]}`)
  },

  human() {
    this.type = htype.HUMAN

    if (human_hex != null) {
      this.alien()
      return
    }
    human_hex = this

    this.setPolygon(human_sym)
  },

  alien() {
    this.type = htype.ALIEN

    if (alien_hex != null) {
      this.pod1()
      return
    }
    alien_hex = this

    this.setPolygon(alien_sym)
  },

  pod1() {
    this.type = htype.POD1

    if (pod1_hex != null) {
      this.pod2()
      return
    }
    pod1_hex = this

    this.setPolygon(pod_sym, `1`)
  },

  pod2() {
    this.type = htype.POD2

    if (pod2_hex != null) {
      this.pod3()
      return
    }
    pod2_hex = this

    this.setPolygon(pod_sym, `2`)
  },

  pod3() {
    this.type = htype.POD3

    if (pod3_hex != null) {
      this.pod4()
      return
    }
    pod3_hex = this

    this.setPolygon(pod_sym, `3`)
  },

  pod4() {
    this.type = htype.POD4

    if (pod4_hex != null) {
      this.blank()
      return
    }
    pod4_hex = this

    this.setPolygon(pod_sym, `4`)
  },

})


const Grid = Honeycomb.defineGrid(Hex)

const xh = Grid.Hex()
const xh_pos = xh.toPoint()
const xh_center = xh.center().add(xh_pos)

blank_sym = draw.group()
blank_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: 'none'})
blank_sym.hide()

silent_sym = draw.group()
silent_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#fff'})
  .stroke({ width: 2, color: '#838383' })
tx = silent_sym.text('A01')
      .font({
          family: 'Share Tech Mono'
        , size: 16
        , anchor: 'middle'
        , leading: 1.4
        , fill: '#000'
      })
      .center(40,23)
silent_sym.hide()

danger_sym = draw.group()
danger_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill('#838383')
  .stroke({width: 2, color: '#838383'})
danger_sym.polygon([
  [4,0],      [6,0],      [7,sq3],    [9,sq3],   [10,sq3*2],
  [9,sq3*3],  [10,sq3*4], [9,sq3*5],  [7,sq3*5], [6,sq3*6],
  [4, sq3*6], [3,sq3*5],  [1, sq3*5], [0,sq3*4], [1,sq3*3],
  [0,sq3*2],  [1,sq3],    [3,sq3]
])
  .translate(1,1)
  .fill('#ddd')
  .size(38)
  .center(xh_center.x,xh_center.y)
danger_sym.text('A01')
      .font({
          family: 'Share Tech Mono'
        , size: 16
        , anchor: 'middle'
        , leading: 1.4
        , fill: '#000'
      })
      .center(40,23)
danger_sym.hide()

human_sym = draw.group()
human_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#000'})
  .stroke({ width: 2, color: '#838383' })
human_sym.path("M18 7 L13 10 V30 L25 38 L37 30 V10 L32 7")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
human_sym.path("M13 18 L25 25 L37 18")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
human_sym.hide()

alien_sym = draw.group()
alien_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#000'})
  .stroke({ width: 2, color: '#838383' })
alien_sym.path("M13 7 L37 20 V34 L25 27 L13 34 V20 L37 7")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
alien_sym.hide()

pod_sym = draw.group()
pod_sym.polygon(xh.corners().map(({ x, y }) => `${x},${y}`))
  .translate(1,1)
  .fill({opacity: 1, color: '#000'})
  .stroke({ width: 2, color: '#838383' })
pod_sym.path("M32 5 H16 L8.5 18")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
pod_sym.path("M18 38 H34 L41.5 25")
  .translate(1,1)
  .fill('none')
  .stroke({width:3, color:'#fff'})
pod_sym.text('1')
      .font({
          family: 'Share Tech Mono'
        , size: 24
        , anchor: 'middle'
        , leading: 1.4
        , fill: '#fff'
        , weight: 'bold'
      })
      .center(32,23)
pod_sym.hide()

const grid = Grid.rectangle({
  width: grid_width,
  height: grid_height,

  onCreate(hex) {
    hex.render(draw)
  }
})

function blankGrid() {
  for(let i = 0; i < grid.length; ++i) {
    let hex = grid.get(i)
    hex.blank()
  }
  human_hex = null
  alien_hex = null
  pod1_hex = null
  pod2_hex = null
  pod3_hex = null
  pod4_hex = null
}

function silentGrid() {
  for(let i = 0; i < grid.length; ++i) {
    let hex = grid.get(i)
    hex.silent()
  }
  human_hex = null
  alien_hex = null
  pod1_hex = null
  pod2_hex = null
  pod3_hex = null
  pod4_hex = null
}

function dangerGrid() {
  for(let i = 0; i < grid.length; ++i) {
    let hex = grid.get(i)
    hex.danger()
  }
  human_hex = null
  alien_hex = null
  pod1_hex = null
  pod2_hex = null
  pod3_hex = null
  pod4_hex = null
}

function loadGrid(str) {
  let grid_array = JSON.parse(str)

  for(let i = 0; i < grid_array.length; ++i) {
    let [ x, y, type ] = grid_array[i]
    let hex = grid.get([x, y])
    let point = hex.toPoint()
    switch(type){
      case htype.NONE:
        hex.blank()
        break;
      case htype.SILENT:
        hex.silent()
        break;
      case htype.DANGER:
        hex.danger()
        break;
      case htype.HUMAN:
        hex.human()
        break;
      case htype.ALIEN:
        hex.alien()
        break;
      case htype.POD1:
        hex.pod1()
        break;
      case htype.POD2:
        hex.pod2()
        break;
      case htype.POD3:
        hex.pod3()
        break;
      case htype.POD4:
        hex.pod4()
        break;
    }
  }
}

drawing.addEventListener('mousedown', (ev) => {
  console.log(ev)
  let { offsetX, offsetY } = ev
  console.log(`${offsetX}, ${offsetY}`)
  const hexCoordinates = Grid.pointToHex([offsetX, offsetY])
  const hex = grid.get(hexCoordinates)

  if (hex) {
    switch(hex) {
      case human_hex:
        human_hex = null 
        break;
      case alien_hex:
        alien_hex = null 
        break;
      case pod1_hex:
        pod1_hex  = null 
        break;
      case pod2_hex:
        pod2_hex  = null 
        break;
      case pod3_hex:
        pod3_hex  = null 
        break;
      case pod4_hex:
        pod4_hex  = null 
        break;
    }

    switch(hex.type){
      case htype.NONE:
        hex.silent()
        break;
      case htype.SILENT:
        hex.danger()
        break;
      case htype.DANGER:
        hex.human()
        break;
      case htype.HUMAN:
        hex.alien()
        break;
      case htype.ALIEN:
        hex.pod1()
        break;
      case htype.POD1:
        hex.pod2()
        break;
      case htype.POD2:
        hex.pod3()
        break;
      case htype.POD3:
        hex.pod4()
        break;
      case htype.POD4:
        hex.blank()
        break;
    }
  }
})
    </script>
  </body>
</html>
